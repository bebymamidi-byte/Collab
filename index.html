<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stop Motion Dashboard</title>
  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- gif.js for export -->
  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.worker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>

  <style>
    :root{
      --bg:#0f1724; --panel:#081024; --muted:#9aa8bf; --accent:#06b6d4; --accent-2:#7c3aed; --glass:rgba(255,255,255,0.02); --radius:12px; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#07102a);color:#e6eef8;padding:18px}
    .app{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .panel{background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01));border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.03)}
    .layout{display:grid;grid-template-columns:300px 1fr;gap:16px}

    /* left sidebar */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .project-list{display:flex;flex-direction:column;gap:8px}
    .project-item{padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .project-item.active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 24px rgba(2,8,23,0.6)}

    .uploader{display:flex;flex-direction:column;gap:8px}
    input[type=file]{display:block}

    /* main area */
    .top-area{display:flex;gap:12px}
    .viewer{flex:1;display:flex;flex-direction:column;gap:10px}
    .canvas-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:10px;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,0.03)}
    canvas{background:#fff;border-radius:6px;max-width:100%;height:auto}

    .controls-row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* timeline */
    .timeline{margin-top:10px;display:flex;gap:8px;overflow:auto;padding:8px;border-radius:8px}
    .thumb{width:90px;height:64px;border-radius:6px;background:#222;background-size:cover;background-position:center;border:2px solid transparent;cursor:pointer}
    .thumb.active{outline:3px solid rgba(124,58,237,0.22)}

    /* right panel */
    .inspector{width:320px;display:flex;flex-direction:column;gap:12px}
    .stat{display:flex;justify-content:space-between;align-items:center}
    .slider{width:100%}

    footer{color:var(--muted);font-size:13px;margin-top:12px;text-align:center}

    @media (max-width:900px){.layout{grid-template-columns:1fr} .inspector{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">SM</div>
        <div>
          <h1>Stop Motion Dashboard</h1>
          <div class="small">Create, preview, and export stop-motion animations</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="newProjectBtn"><i class="fa-solid fa-folder-plus"></i> New Project</button>
        <button class="btn" id="saveProjectBtn" title="Download project JSON"><i class="fa-solid fa-download"></i> Save</button>
        <button class="btn" id="loadProjectBtn"><i class="fa-solid fa-upload"></i> Load</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Projects</div>
          <div class="small" id="projectCount">0</div>
        </div>
        <div class="project-list" id="projectList"></div>

        <div class="uploader panel" style="margin-top:8px">
          <div class="small">Add frames</div>
          <input id="fileInput" type="file" accept="image/*" multiple />
          <label class="small">Or capture from webcam:</label>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="startCamBtn">Start Camera</button>
            <button class="btn" id="captureBtn" disabled>Capture Frame</button>
          </div>
          <video id="video" autoplay playsinline style="display:none;height:120px;border-radius:8px;margin-top:8px;outline:1px solid rgba(255,255,255,0.03)"></video>
        </div>
      </aside>

      <main>
        <div class="top-area">
          <div class="viewer panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>
                <div class="small">Project: <strong id="projectTitle">Untitled</strong></div>
                <div class="small">Frames: <span id="frameCount">0</span></div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn" id="playBtn"><i class="fa-solid fa-play"></i></button>
                <button class="btn" id="stopBtn"><i class="fa-solid fa-stop"></i></button>
                <button class="btn" id="prevBtn"><i class="fa-solid fa-backward-step"></i></button>
                <button class="btn" id="nextBtn"><i class="fa-solid fa-forward-step"></i></button>
                <button class="btn" id="exportGifBtn"><i class="fa-solid fa-image"></i> Export GIF</button>
              </div>
            </div>

            <div class="canvas-wrap" style="min-height:340px">
              <canvas id="stage" width="960" height="540"></canvas>
            </div>

            <div class="controls-row" style="margin-top:6px">
              <div class="small">FPS</div>
              <input id="fps" type="range" min="1" max="30" value="12" class="slider" />
              <div class="small" id="fpsVal">12</div>

              <div style="width:14px"></div>
              <div class="small">Onion skin</div>
              <input id="onionCount" type="range" min="0" max="5" value="2" class="slider" title="Number of previous frames to overlay" />
              <div class="small" id="onionVal">2</div>

              <div style="width:14px"></div>
              <div class="small">Opacity</div>
              <input id="onionOpacity" type="range" min="0" max="100" value="40" class="slider" />
              <div class="small" id="onionOpacityVal">40%</div>
            </div>

            <div class="timeline panel" id="timeline"></div>
          </div>

          <aside class="inspector panel">
            <div>
              <div class="small">Preview Scale</div>
              <input id="scale" type="range" min="25" max="150" value="100" class="slider" />
            </div>

            <div>
              <div class="small">Playback Mode</div>
              <select id="playMode" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)">
                <option value="loop">Loop</option>
                <option value="once">Play Once</option>
                <option value="pingpong">Ping-Pong</option>
              </select>
            </div>

            <div class="stat">
              <div class="small">Selected frame:</div>
              <div class="small" id="selectedIndex">-</div>
            </div>

            <div>
              <div class="small">Delete selected</div>
              <button class="btn" id="deleteFrameBtn">Delete Frame</button>
            </div>

            <div>
              <div class="small">Project JSON</div>
              <textarea id="projectJson" style="width:100%;height:120px;background:#021224;color:#bcd3e8;border-radius:8px;padding:8px;resize:vertical;font-size:12px"></textarea>
            </div>
          </aside>
        </div>

        <footer class="small">Tip: Drag image files onto the timeline area or use the file input. Use webcam capture to grab live frames.</footer>
      </main>
    </div>
  </div>

  <input id="loadFile" type="file" accept="application/json" style="display:none" />

  <script>
    // App state
    let projects = [];
    let currentProject = null;
    let stage = document.getElementById('stage');
    let ctx = stage.getContext('2d');
    let timeline = document.getElementById('timeline');
    let frameCountEl = document.getElementById('frameCount');
    let projectTitleEl = document.getElementById('projectTitle');
    let projectListEl = document.getElementById('projectList');
    let projectCountEl = document.getElementById('projectCount');
    let fpsSlider = document.getElementById('fps');
    let fpsVal = document.getElementById('fpsVal');
    let onionCount = document.getElementById('onionCount');
    let onionVal = document.getElementById('onionVal');
    let onionOpacity = document.getElementById('onionOpacity');
    let onionOpacityVal = document.getElementById('onionOpacityVal');
    let scaleSlider = document.getElementById('scale');
    let playMode = document.getElementById('playMode');
    let selectedIndexEl = document.getElementById('selectedIndex');

    // controls
    document.getElementById('newProjectBtn').addEventListener('click', createNewProject);
    document.getElementById('fileInput').addEventListener('change', handleFileInput);
    document.getElementById('playBtn').addEventListener('click', ()=>startPlayback());
    document.getElementById('stopBtn').addEventListener('click', ()=>stopPlayback());
    document.getElementById('prevBtn').addEventListener('click', ()=>selectFrame((currentProject.currentIndex || 0) - 1));
    document.getElementById('nextBtn').addEventListener('click', ()=>selectFrame((currentProject.currentIndex || 0) + 1));
    fpsSlider.addEventListener('input', ()=>{fpsVal.textContent = fpsSlider.value});
    onionCount.addEventListener('input', ()=>{onionVal.textContent = onionCount.value});
    onionOpacity.addEventListener('input', ()=>{onionOpacityVal.textContent = onionOpacity.value + '%'});
    scaleSlider.addEventListener('input', ()=>{renderStage()});
    document.getElementById('deleteFrameBtn').addEventListener('click', deleteSelectedFrame);
    document.getElementById('saveProjectBtn').addEventListener('click', saveProjectJson);
    document.getElementById('loadProjectBtn').addEventListener('click', ()=>document.getElementById('loadFile').click());
    document.getElementById('loadFile').addEventListener('change', loadProjectFromFile);
    document.getElementById('exportGifBtn').addEventListener('click', exportGIF);

    // webcam
    let video = document.getElementById('video');
    let stream = null;
    document.getElementById('startCamBtn').addEventListener('click', async ()=>{
      if(stream){ stopCamera(); return; }
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720}, audio:false});
        video.srcObject = stream; video.style.display = 'block'; document.getElementById('startCamBtn').textContent = 'Stop Camera'; document.getElementById('captureBtn').disabled = false;
      }catch(e){ alert('Camera access denied or not available') }
    });
    document.getElementById('captureBtn').addEventListener('click', ()=>{
      if(!currentProject) createNewProject();
      const w = stage.width, h = stage.height;
      // draw video to temp canvas
      const tmp = document.createElement('canvas'); tmp.width = w; tmp.height = h; const tctx = tmp.getContext('2d');
      tctx.drawImage(video,0,0,w,h);
      tmp.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        addFrameFromUrl(url);
      },'image/png');
    });
    function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null; video.style.display='none'; document.getElementById('startCamBtn').textContent='Start Camera'; document.getElementById('captureBtn').disabled=true} }

    // playback
    let playing = false; let playTimer = null; let pingPongDir = 1;
    function startPlayback(){ if(!currentProject || currentProject.frames.length===0) return; playing = true; const fps = Number(fpsSlider.value); const interval = 1000 / fps; const mode = playMode.value; clearInterval(playTimer);
      playTimer = setInterval(()=>{
        let idx = currentProject.currentIndex || 0;
        if(mode==='loop') idx = (idx + 1) % currentProject.frames.length;
        else if(mode==='once'){ idx = idx + 1; if(idx >= currentProject.frames.length){ idx = currentProject.frames.length -1; stopPlayback(); }}
        else if(mode==='pingpong'){ idx += pingPongDir; if(idx>=currentProject.frames.length){ pingPongDir = -1; idx = currentProject.frames.length-2 } if(idx<0){ pingPongDir = 1; idx = 1 }}
        selectFrame(idx);
      }, interval);
    }
    function stopPlayback(){ playing = false; clearInterval(playTimer); playTimer = null }

    // project functions
    function createNewProject(){ const p = {id: 'p'+Date.now(), title: 'Project '+(projects.length+1), frames: [], currentIndex:0, created: new Date().toISOString()}; projects.push(p); setCurrentProject(p.id); renderProjectList(); }
    function setCurrentProject(id){ currentProject = projects.find(x=>x.id===id); if(!currentProject) return; projectTitleEl.textContent = currentProject.title; frameCountEl.textContent = currentProject.frames.length; renderTimeline(); projectCountEl.textContent = projects.length; updateProjectJson(); selectFrame(currentProject.currentIndex || 0); }

    function renderProjectList(){ projectListEl.innerHTML=''; projects.forEach(p=>{ const div = document.createElement('div'); div.className='project-item'+(currentProject&&currentProject.id===p.id?' active':''); div.textContent = p.title; div.addEventListener('click', ()=>setCurrentProject(p.id)); projectListEl.appendChild(div) }); projectCountEl.textContent = projects.length; }

    function updateProjectJson(){ document.getElementById('projectJson').value = JSON.stringify(currentProject || {}, null, 2); }

    // timeline
    function renderTimeline(){ timeline.innerHTML=''; if(!currentProject) return; currentProject.frames.forEach((f,i)=>{ const div = document.createElement('div'); div.className = 'thumb'+(i===currentProject.currentIndex?' active':''); div.style.backgroundImage = `url(${f.url})`; div.dataset.index = i; div.addEventListener('click', ()=>selectFrame(i)); timeline.appendChild(div); }); frameCountEl.textContent = currentProject.frames.length; updateProjectJson(); }

    function selectFrame(idx){ if(!currentProject) return; if(idx < 0) idx = 0; if(idx >= currentProject.frames.length) idx = currentProject.frames.length -1; currentProject.currentIndex = idx; selectedIndexEl.textContent = (idx+1) + ' / ' + Math.max(1,currentProject.frames.length); // highlight
      [...timeline.children].forEach(t=>t.classList.toggle('active', Number(t.dataset.index)===idx)); renderStage(); }

    function deleteSelectedFrame(){ if(!currentProject) return; const idx = currentProject.currentIndex || 0; if(currentProject.frames.length===0) return; currentProject.frames.splice(idx,1); if(idx >= currentProject.frames.length) currentProject.currentIndex = currentProject.frames.length-1; renderTimeline(); selectFrame(currentProject.currentIndex || 0); }

    // add frames
    function handleFileInput(e){ const files = Array.from(e.target.files); files.forEach(file=>{ const url = URL.createObjectURL(file); addFrameFromUrl(url); }); e.target.value = '' }
    function addFrameFromUrl(url){ if(!currentProject) createNewProject(); const img = new Image(); img.onload = ()=>{ currentProject.frames.push({url, width: img.width, height: img.height}); renderTimeline(); selectFrame(currentProject.frames.length-1); updateProjectJson(); } img.src = url }

    // stage drawing
    function renderStage(){ ctx.clearRect(0,0,stage.width,stage.height); // determine scale
      const scalePercent = Number(scaleSlider.value)/100;
      const w = stage.width * scalePercent; const h = stage.height * scalePercent; // center
      const ox = (stage.width - w)/2; const oy = (stage.height - h)/2;

      // onion skinning: draw previous N frames with reduced opacity
      if(currentProject && currentProject.frames.length>0){ const idx = currentProject.currentIndex || 0; const onion = Number(onionCount.value); const opacity = Number(onionOpacity.value)/100;
        // draw previous frames back-to-front
        for(let i = Math.max(0, idx - onion); i < idx; i++){
          drawImageToStage(currentProject.frames[i].url, ox, oy, w, h, opacity * ((i - (idx - onion) + 1)/(onion+1)));
        }
        // draw current frame at full opacity
        if(currentProject.frames[idx]) drawImageToStage(currentProject.frames[idx].url, ox, oy, w, h, 1);
      }else{
        // placeholder
        ctx.fillStyle = '#07142a'; ctx.fillRect(0,0,stage.width,stage.height);
        ctx.fillStyle = '#1b3148'; ctx.fillRect(20,20,stage.width-40,stage.height-40);
        ctx.fillStyle = '#7c3aed'; ctx.font = '22px Inter'; ctx.fillText('No frames yet — add images or capture from camera', 40, stage.height/2);
      }
    }

    function drawImageToStage(url, x, y, w, h, alpha=1){ const img = new Image(); img.crossOrigin = 'anonymous'; img.onload = ()=>{ ctx.save(); ctx.globalAlpha = alpha; // cover-mode drawing
        // compute aspect-fit within w,h
        const ar = img.width / img.height; const boxAr = w / h; let dw = w, dh = h; if(ar > boxAr){ dh = w / ar; } else { dw = h * ar; }
        const dx = x + (w - dw)/2; const dy = y + (h - dh)/2; ctx.drawImage(img, dx, dy, dw, dh); ctx.restore(); };
      img.src = url;
    }

    // export GIF
    async function exportGIF(){ if(!currentProject || currentProject.frames.length===0){ alert('No frames to export'); return; }
      const fps = Number(fpsSlider.value); const delay = 1000 / fps; const gif = new GIF({workers:2,quality:10,workerScript: 'https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.worker.js'});
      // add frames
      for(let i=0;i<currentProject.frames.length;i++){
        const img = await loadImage(currentProject.frames[i].url);
        // draw to temp canvas sized to stage
        const tmp = document.createElement('canvas'); tmp.width = stage.width; tmp.height = stage.height; const tc = tmp.getContext('2d'); tc.fillStyle = '#ffffff'; tc.fillRect(0,0,tmp.width,tmp.height);
        // aspect-fit
        const ar = img.width / img.height; const boxAr = tmp.width / tmp.height; let dw = tmp.width, dh = tmp.height; if(ar > boxAr){ dh = tmp.width / ar } else { dw = tmp.height * ar }
        const dx = (tmp.width - dw)/2; const dy = (tmp.height - dh)/2; tc.drawImage(img, dx, dy, dw, dh);
        gif.addFrame(tc, {copy:true, delay});
      }
      // show progress
      const exportingMsg = document.createElement('div'); exportingMsg.className='panel'; exportingMsg.style.position='fixed'; exportingMsg.style.left='50%'; exportingMsg.style.top='20px'; exportingMsg.style.transform='translateX(-50%)'; exportingMsg.textContent='Exporting GIF...'; document.body.appendChild(exportingMsg);
      gif.on('finished', function(blob){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (currentProject.title || 'animation') + '.gif'; a.click(); URL.revokeObjectURL(url); document.body.removeChild(exportingMsg); });
      gif.on('progress', p=>{ exportingMsg.textContent = 'Exporting GIF... ' + Math.round(p*100) + '%'; });
      gif.render();
    }
    function loadImage(url){ return new Promise((res,rej)=>{ const i = new Image(); i.crossOrigin='anonymous'; i.onload = ()=>res(i); i.onerror = rej; i.src = url }); }

    // save/load project JSON
    function saveProjectJson(){ if(!currentProject) return; const data = JSON.stringify(currentProject); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (currentProject.title||'project') + '.json'; a.click(); URL.revokeObjectURL(url); }
    function loadProjectFromFile(e){ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const obj = JSON.parse(reader.result); if(obj && Array.isArray(obj.frames)){ obj.id = obj.id || 'p'+Date.now(); projects.push(obj); setCurrentProject(obj.id); renderProjectList(); } else alert('Invalid project file') }catch(err){ alert('Failed to parse JSON') } }; reader.readAsText(f); }

    // utility
    function renderEverything(){ renderProjectList(); renderTimeline(); renderStage(); updateProjectJson(); }

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){ e.preventDefault(); if(playing) stopPlayback(); else startPlayback(); }
      if(e.key === ',' ) selectFrame((currentProject.currentIndex || 0) -1);
      if(e.key === '.' ) selectFrame((currentProject.currentIndex || 0) +1);
      if(e.key === 'Delete') deleteSelectedFrame();
    });

    // init sample project
    (function init(){
      // setup stage size to 16:9 but scale to CSS
      const baseW = 960, baseH = 540; stage.width = baseW; stage.height = baseH;
      createNewProject(); projects[0].title = 'Demo Project'; renderProjectList(); setCurrentProject(projects[0].id);
      // sample placeholder frames
      const seeds = [ 'https://picsum.photos/seed/sm1/800/450', 'https://picsum.photos/seed/sm2/800/450', 'https://picsum.photos/seed/sm3/800/450' ];
      seeds.forEach(u=> addFrameFromUrl(u));
      // render loop for canvas (to allow images to load progressively)
      setInterval(()=>renderStage(), 120);
    })();
  </script>
</body>
</html>
